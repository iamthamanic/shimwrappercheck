#!/usr/bin/env sh
# Same checks as supabase-checked wrapper (scripts/run-checks.sh).
# Runs on every git push to GitHub so checks are always enforced.
set -e

if git rev-parse --abbrev-ref --symbolic-full-name @{u} >/dev/null 2>&1; then
  RANGE="@{u}...HEAD"
  CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$RANGE")
else
  if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
    CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR HEAD~1...HEAD)
  else
    CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR --root HEAD)
  fi
fi

if [ -z "$CHANGED_FILES" ]; then
  exit 0
fi

run_frontend=false
run_backend=false

printf "%s\n" "$CHANGED_FILES" | grep -q '^src/' && run_frontend=true
printf "%s\n" "$CHANGED_FILES" | grep -q '^supabase/functions/' && run_backend=true
# dashboard/scripts/templates (e.g. shimwrappercheck repo or monorepos)
printf "%s\n" "$CHANGED_FILES" | grep -qE '^dashboard/|^scripts/|^templates/' && run_frontend=true

if [ "$run_frontend" = false ] && [ "$run_backend" = false ]; then
  exit 0
fi

# Full mode: Node orchestrator (all checks + Stryker + E2E + AI deductive review). Loads .env for API keys.
if [ -f "node_modules/.bin/shimwrappercheck" ] || command -v shimwrappercheck >/dev/null 2>&1; then
  npx shimwrappercheck run --full || exit 1
else
  unset SKIP_AI_REVIEW
  CHECK_ARGS=""
  [ "$run_frontend" = true ] && CHECK_ARGS="--frontend"
  [ "$run_backend" = true ] && CHECK_ARGS="${CHECK_ARGS:+$CHECK_ARGS }--backend"
  bash scripts/run-checks.sh $CHECK_ARGS
fi

# Update README (e.g. "Last updated" line) so it stays in sync on push
if [ -f scripts/update-readme-on-push.sh ]; then
  bash scripts/update-readme-on-push.sh
  if ! git diff --quiet README.md 2>/dev/null; then
    git add README.md
    git commit -m "docs: update README (auto on push)"
  fi
fi
